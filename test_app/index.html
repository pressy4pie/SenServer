<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <script src="mqttws31.js" type="text/javascript"></script>
  <script type="text/javascript">

    //sample HTML/JS script that will publish/subscribe to topics in the Google Chrome Console
    //by Matthew Bordignon @bordignon on twitter.

    var wsbroker = "ekg.westus.cloudapp.azure.com";  //mqtt websocket enabled broker
    var wsport = 3002 // port for above
    var serial_number = 'test_serial' 
    var node_list = {};
    var alarms_list = {};
    var timers_list = {};
    var inclusion_mode;

    var client = new Paho.MQTT.Client(wsbroker, wsport,
        "testApp");

    client.onConnectionLost = function (responseObject) {
      console.log("connection lost: " + responseObject.errorMessage);
    };

    client.onMessageArrived = function (message) {
      //console.log(message.destinationName, ' -- ', message.payloadString);
        switch(message.destinationName){
        case '/zc/' + "test_serial" + '/node/':
          raw_msg = message.payloadString;
          if( raw_msg == 'done'){
            console.log(JSON.stringify(node_list,null,8)); 
          } else{
            console.log("new nodes published, fetching...");
            var node = JSON.parse(raw_msg);
            node_list["node " + node._id] = node;
          }       
        break;
        
        case '/zc/' + serial_number + '/debug/raw_ms_msg':
            //console.log(message.payloadString);
            break;
           
        // placeholders.    
        case '/zc/' + "test_serial" + '/alarm/':
            // make a json of the json. 
            raw_msg = message.payloadString;
            if( raw_msg == 'done'){
              console.log(JSON.stringify(alarms_list,null,8));
            } else {
              console.log("new alarms published, fetching...");

              var alarm = JSON.parse(raw_msg);
              //add it to our list. 
              alarms_list["alarm "+alarm._id] = alarm;
            } 
        break;
        
        case '/zc/' + "test_serial" + '/timer/':
            raw_msg = message.payloadString;
            if( raw_msg == 'done' ){
              console.log(JSON.stringify(timers_list,null,8)); 
            }
            else{        
              console.log("new timers published, fetching..");
              // make a json of the json. 
              var timer = JSON.parse(raw_msg);
            
              //add it to our list. 
              timers_list["timer "+timer._id] = timer; 
            }
        break;
        
        case '/zc/' + serial_number + '/current_inclusion_mode/':
          raw_msg = message.payloadString;
          if ( inclusion_mode != raw_msg ){
            inclusion_mode = raw_msg;
            console.log('INCLUSION MODE: ' + inclusion_mode );
          }
        break;
    } 
    };

    var options = {
      timeout: 3,
      onSuccess: function () {
        console.log("mqtt connected");
        // Connection succeeded; subscribe to our topic, you can add multile lines of these
        client.subscribe('/zc/test_serial/#', {qos: 1});
        initmessage = new Paho.MQTT.Message("connect");
        initmessage.destinationName = "/zc/test_serial/";
        client.send(initmessage);
      },
      onFailure: function (message) {
        console.log("Connection failed: " + message.errorMessage);
      }
    };

  function init() {
      client.connect(options);
  }
  
  function get_nodes(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_nodes/";
        client.send(message);
        setTimeout(function(){alert(JSON.stringify(node_list,null,8))}, 100);
  }
  
  function get_alarms(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_alarms/";
        client.send(message);
        alert(JSON.stringify(alarms_list,null,8));
  }
  
  function get_timers(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_timers/";
        client.send(message);
        alert(JSON.stringify(timers_list,null,8));
  }
  
  function up(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 29, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function down(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 30, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function stop(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 31, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function create_alarm(){  
    var alarm_msg =  {
    name : 'test alarm',
    enabled : true,
    created : Date.now(),    
    valid_from : Date.now(),
    valid_thru : 1559336567,
    delay : 30, // seconds
    
    node_to_check : 1, // the node  
    sensor_to_check : 2, // the sensor on that node. 
    condition : 'gt', // greater than
    value : 13,
    
    notify_email : ['connor@emeraldkingdomgreenhouse.com'],
    execute : [{'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 31, 'payload': 1 }]
    };
  
    message = new Paho.MQTT.Message( JSON.stringify(alarm_msg) ) ;
    message.destinationName = "/zc/test_serial/create_alarm/";
    client.send(message);
  }
  
  function toggle_include(){
    var msg = 'set';
    var message = new Paho.MQTT.Message( msg ) ;
    message.destinationName = '/zc/' + serial_number + "/set_inclusion_mode/";
    client.send(message);
  }

</script>
  </head>
  <body onload="init();">
        <button onclick=" init();" > connect to mqtt</button>
        <button onclick=" get_nodes(); ">Get Nodes</button>
        <button onclick=" get_alarms(); ">Get Alarms</button>
        <button onclick=" get_timers(); ">Get Timers</button>
        
        
        <button onclick=" up(); ">up</button>
        <button onclick=" down(); ">down</button>
        <button onclick=" stop(); ">stop</button>
        
        <button onclick=" create_alarm(); ">create_alarm</button>
        <button onclick=" toggle_include(); ">turn inclusion mode on.</button>
  </body>

</html>