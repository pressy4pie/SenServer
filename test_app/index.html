<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <script src="mqttws31.js" type="text/javascript"></script>
  <script type="text/javascript">

    //sample HTML/JS script that will publish/subscribe to topics in the Google Chrome Console
    //by Matthew Bordignon @bordignon on twitter.
    
    // This can probably be localhost when we put it up on the server.
    var wsbroker = "ekg.westus.cloudapp.azure.com";  //mqtt websocket enabled broker
    
    var wsport = 3002 // port for above
    var serial_number = 'test_serial' 
    var node_list = new Object;
    var alarms_list = new Object;
    var timers_list = new Object;
    var inclusion_mode;

    var client = new Paho.MQTT.Client(wsbroker, wsport,
        "testApp");

    client.onConnectionLost = function (responseObject) {
      console.log("connection lost: " + responseObject.errorMessage);
    };

    client.onMessageArrived = function (message) {
      //console.log(message.destinationName, ' -- ', message.payloadString);
        switch(message.destinationName){
        case '/zc/' + "test_serial" + '/node/':
          raw_msg = message.payloadString;
          if( raw_msg == 'done'){
            //console.log(JSON.stringify(node_list,null,8)); 
          } else{
            //console.log("new nodes published, fetching...");
            var node = JSON.parse(raw_msg);
            node_list["node " + node._id] = node;
            document.getElementById("nodes_box").value = JSON.stringify(node_list,null,8);
          }       
        break;
        
        case '/zc/' + serial_number + '/debug/raw_ms_msg':
            //console.log(message.payloadString);
            break;
           
        // placeholders.    
        case '/zc/' + "test_serial" + '/alarm/':
            // make a json of the json. 
            raw_msg = message.payloadString;
            if( raw_msg == 'done'){
              //console.log(JSON.stringify(alarms_list,null,8));
            } else {
              //console.log("new alarms published, fetching...");

              var alarm = JSON.parse(raw_msg);
              //add it to our list. 
              alarms_list["alarm "+alarm._id] = alarm;
              document.getElementById("alarms_box").value = JSON.stringify(alarms_list,null,8);
            } 
        break;
        
        case '/zc/' + "test_serial" + '/timer/':
            raw_msg = message.payloadString;
            if( raw_msg == 'done' ){
             // console.log(JSON.stringify(timers_list,null,8)); 
            }
            else{        
              //console.log("new timers published, fetching...");
              // make a json of the json. 
              var timer = JSON.parse(raw_msg);
            
              //add it to our list. 
              timers_list["timer "+timer._id] = timer; 
              document.getElementById("timers_box").value = JSON.stringify(timers_list,null,8);
            }
        break;
        
        case '/zc/' + serial_number + '/current_inclusion_mode/':
          raw_msg = message.payloadString;
          if ( inclusion_mode != raw_msg ){
            inclusion_mode = raw_msg;
            console.log('INCLUSION MODE: ' + inclusion_mode );
            document.getElementById("include_box").value = "INCLUSION MODE: " +inclusion_mode;
          }
        break;
    } 
    };

    var options = {
      timeout: 3,
      onSuccess: function () {
        console.log("mqtt connected");
        // Connection succeeded; subscribe to our topic, you can add multile lines of these
        client.subscribe('/zc/test_serial/#', {qos: 1});
        initmessage = new Paho.MQTT.Message("connect");
        initmessage.destinationName = "/zc/test_serial/";
        client.send(initmessage);
      },
      onFailure: function (message) {
        console.log("Connection failed: " + message.errorMessage);
      }
    };

  function init() {
      client.connect(options);
  }
  
  function get_all(){
    get_nodes();
    get_alarms();
    get_timers();
  }
  
  function get_nodes(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_nodes/";
        client.send(message);
        if(Object.keys(node_list).length === 0){
          console.log('No Nodes');
        } else {
          //alert(JSON.stringify(node_list,null,8));
          document.getElementById("nodes_box").value = JSON.stringify(node_list,null,8);
        }
  }
  
  function get_alarms(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_alarms/";
        client.send(message);
        if(Object.keys(alarms_list).length === 0){
          console.log('No Alarms');
        } else {
          document.getElementById("alarms_box").value = JSON.stringify(alarms_list,null,8);
        }
  }
  
  function get_timers(){
        message = new Paho.MQTT.Message("get");
        message.destinationName = "/zc/test_serial/get_timers/";
        client.send(message);
        if(Object.keys(timers_list).length === 0){
          console.log('No timers');
        } else {
          document.getElementById("timers_box").value = JSON.stringify(timers_list,null,8);
        }
  }
  
  function up(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 29, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function down(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 30, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function stop(){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 31, 'payload': 1 };
        message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
        message.destinationName = "/zc/test_serial/update_sensor_variable/";
        client.send(message);
  }
  
  function update_node_one_name(){
    var nameValue = document.getElementById('nodeonename').value;
    if (nameValue != null){
      var msg = {'node_id': 1, 'diaplayName': nameValue };
      message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
      message.destinationName = "/zc/test_serial/update_node_display_name/";
      client.send(message);
      get_nodes();
    }
  }
  
  function update_node_one_sensor_one_name(){
    var nameValue = document.getElementById('node_one_sensor_one_name').value;
    if (nameValue != null){
      var msg = {'node_id': 1, 'sensor_id' : 1, 'displayName': nameValue };
      message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
      message.destinationName = "/zc/test_serial/update_sensor_display_name/";
      client.send(message);
      get_nodes();
    }
  }
  
  function reboot_node_one(){
    var msg = {'node_id': 3};
    message = new Paho.MQTT.Message( JSON.stringify(msg) ) ;
    message.destinationName = "/zc/test_serial/reboot_node/";
    client.send(message);
  }
  
  function create_alarm(){  
    var alarm_msg =  {
      name : 'test alarm',
      enabled : true,
      created : Date.now(),    
      valid_from : Date.now(),
      valid_thru : 1559336567,
      delay : 30, // seconds
      
      node_to_check : 1, // the node  
      sensor_to_check : 2, // the sensor on that node. 
      condition : 'gt', // greater than
      value : 13,
      
      notify_email : ['connor@emeraldkingdomgreenhouse.com'],
      execute : [{'node_id': 1, 'sensor_id' : 1, 'msg_cmd': 1, 'msg_type' : 31, 'payload': 1 }]
    };
  
    message = new Paho.MQTT.Message( JSON.stringify(alarm_msg) ) ;
    message.destinationName = "/zc/test_serial/create_alarm/";
    client.send(message);
  }
  
  function toggle_include(){
    var msg = 'set';
    var message = new Paho.MQTT.Message( msg ) ;
    message.destinationName = '/zc/' + serial_number + "/set_inclusion_mode/";
    client.send(message);
  }

</script>
  </head>
  <body onload="init();">
<link href="css/bootstrap.min.css" rel="stylesheet">
    <div id="nodes" class="col-sm-4">
      <h3>NODES</h3><button onclick=" get_nodes(); ">Force Get Nodes</button> <br>
      <textarea rows="20" cols="55" id="nodes_box">
      </textarea>
    </div>
    
    <div id="alarms" class="col-sm-4">
      <h3>ALARMS</h3> <button onclick=" get_alarms(); ">Force Get Alarms</button> <br>
      <textarea rows="20" cols="50" id="alarms_box">
      </textarea><br>
      <button onclick=" create_alarm(); ">Create Timer</button>
      <button onclick=" create_alarm(); ">Delete Timer</button>
    </div>
    
    <div id="timers" class="col-sm-4">
      <h3>TIMERS</h3> <button onclick=" get_timers(); ">Force Get Timers</button> <br>
      <textarea rows="20" cols="50" id="timers_box">
      </textarea><br>
      <button onclick=" create_alarm(); ">Create Timer</button>
      <button onclick=" create_alarm(); ">Delete Timer</button>
    </div>
    
    <div id="functions">
      <h4>EXTRA STUFF</h4>
     
      <h4>Node 1 Stuff.</h4>
      <button onclick=" up(); ">up on sensor 1</button>
      <button onclick=" down(); ">down on sensor 1</button>
      <button onclick=" stop(); ">stop on sensor 1</button>
      <button onclick=" reboot_node_one(); ">Reboot node 1</button><br>
      <input type="text" id="nodeonename" value=""> <button onclick=" update_node_one_name(); ">update name on node 1</button><br><br>
      <input type="text" id="node_one_sensor_one_name" value=""> <button onclick=" update_node_one_sensor_one_name(); ">update name on node 1 sensor 1</button> 
      <input type="text" id="node_one_sensor_one_name" value=""> <button onclick=" update_node_one_sensor_one_name(); ">update name on node 1 sensor 1</button> 
      
      <br><br>
      
      <button onclick=" toggle_include(); ">turn inclusion mode on.</button> <input type="text" id="include_box" value="off"> <br>
      <button onclick=" get_all() ">Force get all info.</button><br>
      <br>
    </div>  
             
  </body>

</html>
